<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IT Learn | Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="login.css">

  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script src="/translations.js"></script>
</head>
<body>

<header class="top-bar">
  <div class="logo">
    <img src="favicon.ico" alt="IT Learn logo">
    <span>IT Learn</span>
  </div>
  <a href="index.html" class="back-link">‚Üê Back to home</a>
</header>

<main class="hero">
  <div class="login-card">
    <span class="badge">Welcome back</span>
    <h1>Login to <span>IT Learn</span></h1>
    <p class="subtitle">Continue learning without frustration.</p>

    <form id="login-form">
      <div class="field">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="example@example.com" required>
      </div>

      <div class="field">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" placeholder="********" required>
      </div>

      <div class="cf-turnstile" data-sitekey="0x4AAAAAACDEaJSXddDZ6jRf"></div>

      <button type="submit" class="primary-btn">Login</button>
    </form>

    <div class="divider"><span>OR</span></div>

    <!-- OAuth -->
    <div class="oauth-container">
      <button class="oauth google" id="google-login">
        <img src="https://files.itlearn.be/images/branding/icons/Google.png" alt="Google">
        <span>Continue with Google</span>
      </button>

      <button class="oauth github" id="github-login">
        <img src="https://files.itlearn.be/images/branding/icons/GitHub.png" alt="GitHub">
        <span>Continue with GitHub</span>
      </button>

      <button class="oauth discord" id="discord-login">
        <img src="https://files.itlearn.be/images/branding/icons/discord.png" alt="Discord">
        <span>Continue with Discord</span>
      </button>
    </div>

    <p class="footer-text">
      No account yet? <a href="signup.html">Create one</a>
    </p>
  </div>
</main>

<script>
const OAUTH_API_BASE = 'https://itlearn.pythonanywhere.com';

const loginForm = document.getElementById('login-form');
if (loginForm) {
  loginForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    const email = document.getElementById('email')?.value || '';
    const password = document.getElementById('password')?.value || '';
    const submitBtn = loginForm.querySelector('button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;

    let captchaToken = '';
    try {
      if (typeof turnstile !== 'undefined') {
        captchaToken = turnstile.getResponse();
      }
    } catch {}

    if (!captchaToken) {
      alert('Please complete the CAPTCHA before logging in.');
      if (submitBtn) submitBtn.disabled = false;
      return;
    }

    try {
      const res = await fetch(`${OAUTH_API_BASE}/api/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ email, password, captcha_token: captchaToken })
      });

      if (!res.ok) {
        let msg = 'Login failed.';
        try {
          const data = await res.json();
          if (data && data.error) msg = data.error;
        } catch {}
        alert(msg);
        try { turnstile.reset(); } catch {}
        return;
      }

      window.location.href = '/learn/index.html';
    } catch {
      alert('An error occurred while logging in.');
      try { turnstile.reset(); } catch {}
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  });
}

function initOAuthButton(provider, buttonId) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;

  btn.addEventListener('click', async () => {
    btn.disabled = true;
    btn.innerText = `Connecting to ${provider}...`;

    try {
      const redirectTo = `${window.location.origin}/oauth-callback.html?provider=${provider}`;
      const res = await fetch(`${OAUTH_API_BASE}/api/oauth/${provider}/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ redirect_to: redirectTo })
      });

      const data = await res.json();
      if (!res.ok || !data.url) throw new Error();

      window.location.href = data.url;
    } catch {
      alert(`Could not start ${provider} login`);
      btn.disabled = false;
      btn.innerText = `Continue with ${provider}`;
    }
  });
}

initOAuthButton('google', 'google-login');
initOAuthButton('github', 'github-login');
initOAuthButton('discord', 'discord-login');
</script>

<script>
// --- Splash text ---
const variants = [
  { text: "welcomeAboard" },
  { text: "createSomethingCool" },
  { text: "devJourneyStarts" },
  { text: "smallStepsBigBuilds" },
  { text: "designCodeRepeat" },
  { text: "developedByBroodje56", link: "https://broodje56.is-a.dev" },
  { text: "developedByJoren", link: "https://github.com/JorenS15" },
  { text: "joinDiscord", link: "https://discord.gg/rKgF9s32EV" },
  { text: "programmingEqualsLife" },
  { text: "keepPushingForward" },
  { text: "codeYourDreams" },
  { text: "debuggingIsFun" },
  { text: "eatSleepCodeRepeat" },
  { text: "thinkTwiceCodeOnce" },
  { text: "helloWorld" },
  { text: "brainExeStopped" },
  { text: "codeLikeABoss" },
  { text: "syntaxNeverSleeps" },
  { text: "fromIdeasToApps" },
  { text: "firstBugIsFriend" },
  { text: "ctrlSProgress" },
  { text: "keepCalmCodeOn" },
  { text: "oneLineAtATime" },
  { text: "compileYourDreams" },
  { text: "futureDevInProgress" },
  { text: "readySetDeploy" },
  { text: "helloFutureProgrammer" },
  { text: "error404" },
  { text: "learningNeverStops" },
  { text: "codingPlusMusic", link: "https://open.spotify.com/track/4tZgM0PdoK8MG5jvMKdJkC" }
];

const choice = variants[Math.floor(Math.random() * variants.length)];
const box = document.querySelector('.login-card');
if (box) {
  const a = document.createElement('a');
  a.className = 'splash';
  if (choice.link) a.href = choice.link;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  const lang = localStorage.getItem('language') || 'en';
  const translationsMap = typeof translations !== 'undefined' ? translations : {};
  const translated = translationsMap[lang] && translationsMap[lang][choice.text];
  a.textContent = translated || choice.text;
  box.appendChild(a);
}
</script>

</body>
</html>
