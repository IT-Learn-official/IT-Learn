<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IT Learn | Sign Up</title>
  <link rel="stylesheet" href="signup.css" />
  <meta property="og:title" content="IT Learn">
  <meta property="og:description" content="Learn programming for free! - IT Learn">
  <meta property="og:image" content="https://files.itlearn.be/images/branding/logo/IT_Learn.png">
  <meta property="og:type" content="website">

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js" onload="if(window.feather){feather.replace();}" ></script>
  <script src="/translations.js"></script>
</head>

<body>

<!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/690b61d5727def194d09e47e/1j9a7caec';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->

<header class="top-bar">
  <div class="logo">
    <img src="favicon.ico" alt="IT Learn logo">
    <span>IT Learn</span>
  </div>
  <a href="index.html" class="back-link">&#8592; Back to home</a>
</header>

<main class="hero">
  <div class="login-card">
    <span class="badge" data-translate="signup">Sign Up</span>
    <h1><span>IT Learn</span> <span data-translate="signup">Sign Up</span></h1>
    <p class="subtitle">Start learning without frustration.</p>

    <form id="signup-form">
      <div class="field">
        <label for="email" data-translate="email">Email</label>
        <input type="email" id="email" placeholder="Enter your email" data-translate="enterEmail" required>
      </div>

      <div class="field password">
        <label for="password" data-translate="password">Password</label>
        <div class="input-row">
          <input type="password" id="password" placeholder="Create a password" data-translate="createPassword" required>
          <button type="button" class="password-toggle" aria-pressed="false" aria-label="Show password" title="Show password">
            <i data-feather="eye">&#128065;</i>
          </button>
        </div>
      </div>

      <div class="field password">
        <label for="confirm-password" data-translate="confirmPassword">Confirm Password</label>
        <div class="input-row">
          <input type="password" id="confirm-password" placeholder="Re-enter your password" data-translate="reenterPassword" required>
          <button type="button" class="password-toggle" aria-pressed="false" aria-label="Show password" title="Show password">
            <i data-feather="eye">&#128065;</i>
          </button>
        </div>
      </div>

      <!-- Cloudflare Turnstile -->
      <div class="cf-turnstile" data-sitekey="0x4AAAAAACDEaJSXddDZ6jRf"></div>

      <div class="terms-row">
        <label>
          <input type="checkbox" id="accept-terms">
          <span data-translate="iAgree">I agree to the</span>
          <a href="/terms/terms.html" target="_blank" rel="noopener noreferrer" data-translate="signupTerms">Terms and Conditions</a>
        </label>
      </div>

      <button type="submit" class="primary-btn" data-translate="createAccount">Create account</button>
    </form>

    <div class="divider"><span data-translate="or">OR</span></div>

    <div class="oauth-container">
      <button class="oauth google" id="google-login" data-connecting="Connecting to Google...">
        <img src="https://files.itlearn.be/images/branding/icons/Google.png" alt="Google">
        <span class="oauth-label" data-translate="continueGoogle">Continue with Google</span>
      </button>

      <button class="oauth github" id="github-login" data-connecting="Connecting to GitHub...">
        <img src="https://files.itlearn.be/images/branding/icons/GitHub.png" alt="GitHub">
        <span class="oauth-label" data-translate="continueGitHub">Continue with GitHub</span>
      </button>

      <button class="oauth discord" id="discord-login" data-connecting="Connecting to Discord...">
        <img src="https://files.itlearn.be/images/branding/icons/discord.png" alt="Discord">
        <span class="oauth-label" data-translate="continueDiscord">Continue with Discord</span>
      </button>
    </div>

    <div class="discord-join-option">
      <label>
        <input type="checkbox" id="join-discord-server" checked>
        <span data-translate="joinDiscordServer">Join our official Discord server</span>
      </label>
    </div>

    <p class="footer-text">
      Already have an account? <a href="login.html">Log in</a>
    </p>
  </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    document.body.setAttribute('data-page', 'signup');
    const storedLang = localStorage.getItem('language') || 'en';
    updatePageLanguage(storedLang);
    updateInputPlaceholders(storedLang);
    initPasswordToggle();
    updatePasswordToggleLabels(storedLang);
    initOAuthButtons();

    try {
      const resp = await fetch('https://itlearn.pythonanywhere.com/api/session', {
        method: 'GET',
        credentials: 'include'
      });
      const session = await resp.json();
      if (session.logged_in) {
        window.location.href = '/learn/index.html';
        return;
      }
    } catch (e) {
      console.warn('[SIGNUP] Session pre-check failed:', e);
    }

    setTimeout(() => {
      try {
        if (typeof turnstile !== 'undefined') {
          const oldToken = turnstile.getResponse();
          console.log('[SIGNUP] Page load - old token (first 20):', oldToken ? oldToken.substring(0, 20) + '...' : 'NONE');
          turnstile.reset();
          console.log('[SIGNUP] Turnstile reset on page load');
        }
      } catch (e) {
        console.warn('[SIGNUP] Could not reset Turnstile on load:', e);
      }
    }, 1000);
  });
  
  function updateInputPlaceholders(lang) {
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    if (emailInput) emailInput.placeholder = translations[lang]['enterEmail'] || 'Enter your email';
    if (passwordInput) passwordInput.placeholder = translations[lang]['createPassword'] || 'Create a password';
    if (confirmPasswordInput) confirmPasswordInput.placeholder = translations[lang]['reenterPassword'] || 'Re-enter your password';
  }

  function updatePasswordToggleLabels(lang) {
    const btns = document.querySelectorAll('.password-toggle');
    if (!btns) return;
    btns.forEach(btn => {
      const show = translations[lang] && translations[lang]['showPassword'] ? translations[lang]['showPassword'] : 'Show password';
      const hide = translations[lang] && translations[lang]['hidePassword'] ? translations[lang]['hidePassword'] : 'Hide password';
      btn.dataset.showLabel = show;
      btn.dataset.hideLabel = hide;
      const isPressed = btn.getAttribute('aria-pressed') === 'true';
      btn.setAttribute('aria-label', isPressed ? hide : show);
      btn.setAttribute('title', isPressed ? hide : show);
    });
  }

  const OAUTH_API_BASE = 'https://itlearn.pythonanywhere.com';

  function providerLabel(provider) {
    switch (provider) {
      case 'github': return 'GitHub';
      case 'discord': return 'Discord';
      default: return 'Google';
    }
  }

  function initOAuthButton(provider, buttonId) {
    const btn = document.getElementById(buttonId);
    if (!btn) return;
    const labelEl = btn.querySelector('.oauth-label');
    const baseLabel = labelEl ? labelEl.textContent : btn.textContent;
    const connecting = btn.dataset.connecting || `Connecting to ${providerLabel(provider)}...`;

    btn.addEventListener('click', async () => {
      btn.disabled = true;
      if (labelEl) {
        labelEl.textContent = connecting;
      } else {
        btn.textContent = connecting;
      }

      if (provider === 'discord') {
        const joinCheckbox = document.getElementById('join-discord-server');
        const shouldJoin = joinCheckbox ? joinCheckbox.checked : false;
        localStorage.setItem('discord_join_server', shouldJoin ? 'true' : 'false');
      }

      try {
        const redirectTo = `${window.location.origin}/oauth-callback.html?provider=${provider}`;
        const res = await fetch(`${OAUTH_API_BASE}/api/oauth/${provider}/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ redirect_to: redirectTo })
        });

        const data = await res.json();
        if (!res.ok || !data.url) {
          const errMsg = data && data.error ? data.error : `Could not start ${providerLabel(provider)} login.`;
          throw new Error(errMsg);
        }

        window.location.href = data.url;
      } catch (err) {
        console.error(`[OAUTH][${provider}] Start failed:`, err);
        alert(`Could not start ${providerLabel(provider)} sign-in. Please try again.`);
        btn.disabled = false;
        if (labelEl) {
          labelEl.textContent = baseLabel;
        } else {
          btn.textContent = baseLabel;
        }
      }
    });
  }

  function initOAuthButtons() {
    initOAuthButton('google', 'google-login');
    initOAuthButton('github', 'github-login');
    initOAuthButton('discord', 'discord-login');
  }

  function initPasswordToggle() {
    document.querySelectorAll('.password-toggle').forEach(btn => {
      const row = btn.closest('.input-row');
      const input = row ? row.querySelector('input') : null;
      if (!input) return;

      if (window.feather) feather.replace();

      btn.addEventListener('click', () => {
        const showing = input.type === 'text';
        if (showing) {
          input.type = 'password';
          btn.setAttribute('aria-pressed', 'false');
          const show = btn.dataset.showLabel || 'Show password';
          btn.setAttribute('aria-label', show);
          btn.setAttribute('title', show);
          btn.innerHTML = '<i data-feather="eye"></i>';
        } else {
          input.type = 'text';
          btn.setAttribute('aria-pressed', 'true');
          const hide = btn.dataset.hideLabel || 'Hide password';
          btn.setAttribute('aria-label', hide);
          btn.setAttribute('title', hide);
          btn.innerHTML = '<i data-feather="eye-off"></i>';
        }
        if (window.feather) feather.replace();
        input.focus();
      });
    });
  }
  
  const originalUpdatePageLanguage = window.updatePageLanguage;
  window.updatePageLanguage = function(lang) {
    originalUpdatePageLanguage(lang);
    updateInputPlaceholders(lang);
    updatePasswordToggleLabels(lang);
  };
  
  document.getElementById("signup-form").addEventListener("submit", async (e) => {
    e.preventDefault();
  
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirm-password").value;
    const acceptTerms = document.getElementById("accept-terms").checked;
    const submitBtn = document.querySelector('#signup-form .primary-btn');
    if (submitBtn) submitBtn.disabled = true;

    if (!email || !password) {
        alert("Email and password are required");
        if (submitBtn) submitBtn.disabled = false;
        return;
    }
  
    if (password !== confirmPassword) {
        alert("Passwords do not match");
        if (submitBtn) submitBtn.disabled = false;
        return;
    }
  
    if (!acceptTerms) {
        alert("You must accept the terms and conditions");
        if (submitBtn) submitBtn.disabled = false;
        return;
    }

    let captchaToken = turnstile.getResponse();
    let tokenPrefix = captchaToken ? captchaToken.substring(0, 20) : 'NONE';
    console.log('[SIGNUP] Initial token check:', captchaToken ? 'Token exists' : 'No token');
    console.log('[SIGNUP] Token prefix:', tokenPrefix);

    const lastToken = sessionStorage.getItem('signup_last_captcha_token');
    if (lastToken && lastToken === tokenPrefix) {
      console.error('[SIGNUP] ⚠️ WARNING: REUSING SAME TOKEN!');
      alert('Please wait for CAPTCHA to reset...');
      try { turnstile.reset(); } catch {}
      if (submitBtn) submitBtn.disabled = false;
      return;
    }

    if (!captchaToken) {
      console.log('[SIGNUP] Waiting for token to generate...');
      for (let i = 0; i < 6; i++) {
        await new Promise(resolve => setTimeout(resolve, 500));
        captchaToken = turnstile.getResponse();
        if (captchaToken) {
          tokenPrefix = captchaToken.substring(0, 20);
          console.log('[SIGNUP] Token ready after', (i + 1) * 500, 'ms');
          break;
        }
      }
    }

    if (!captchaToken) {
      console.error('[SIGNUP] No CAPTCHA token available after waiting');
      alert('CAPTCHA verification not ready. Please wait a moment and try again.');
      try { turnstile.reset(); } catch {}
      if (submitBtn) submitBtn.disabled = false;
      return;
    }

    sessionStorage.setItem('signup_last_captcha_token', tokenPrefix);
    console.log('[SIGNUP] Submitting with token (first 20 chars):', tokenPrefix + '...');

    try {
        const requestBody = {
          email,
          password,
          captcha_token: captchaToken
        };
        console.log('[SIGNUP] Request body:', { email, captcha_token_length: captchaToken.length });

        const res = await fetch("https://itlearn.pythonanywhere.com/api/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(requestBody)
        });
  
        let data = null;
        try { data = await res.json(); } catch {}

        if (!res.ok) {
            const msg = (data && data.error) ? data.error : 'Signup failed.';
            console.error('[SIGNUP] Error details:', { status: res.status, errorMessage: msg, fullErrorData: data });
            alert('Signup failed: ' + msg);
            try {
              turnstile.reset();
              await new Promise(resolve => setTimeout(resolve, 500));
            } catch {}
            if (submitBtn) submitBtn.disabled = false;
            return;
        }

        if (data && data.error) {
            console.error('[SIGNUP] Error details:', data.error);
            alert('Error: ' + data.error);
            try { turnstile.reset(); } catch {}
            if (submitBtn) submitBtn.disabled = false;
            return;
        }

        console.log('[SIGNUP] Success! Checking for trial data...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const isFromTrial = urlParams.get('trial') === 'completed';
        
        if (isFromTrial) {
          console.log('[SIGNUP] Trial completion detected, linking trial progress...');
          try {
            const trialSessionData = localStorage.getItem('itlearn_trial_session');
            const trialProgressData = localStorage.getItem('itlearn_trial_progress');
            
            if (trialSessionData && trialProgressData) {
              const trialSession = JSON.parse(trialSessionData);
              const trialProgress = JSON.parse(trialProgressData);
              
              const trialDataForLinking = {
                sessionId: trialSession.sessionId,
                courseId: trialSession.courseId,
                startedAt: trialSession.startedAt,
                expiresAt: trialSession.expiresAt,
                chapters: trialProgress.chapters || []
              };
              
              console.log('[SIGNUP] Linking trial data with backend...');
              const linkRes = await fetch('https://itlearn.pythonanywhere.com/api/trial/link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(trialDataForLinking)
              });
              
              if (linkRes.ok) {
                const linkData = await linkRes.json();
                console.log('[SIGNUP] Trial progress linked successfully:', linkData);
                
                localStorage.removeItem('itlearn_trial_session');
                localStorage.removeItem('itlearn_trial_progress');
                console.log('[SIGNUP] Trial data cleared from localStorage');
              } else {
                console.warn('[SIGNUP] Failed to link trial progress, but account created:', linkRes.status);
                localStorage.removeItem('itlearn_trial_session');
                localStorage.removeItem('itlearn_trial_progress');
              }
            }
          } catch (trialErr) {
            console.warn('[SIGNUP] Error linking trial data:', trialErr);
            localStorage.removeItem('itlearn_trial_session');
            localStorage.removeItem('itlearn_trial_progress');
          }
        }
        
        console.log('[SIGNUP] Signup complete, redirecting to /learn/index.html');
        alert('Signup successful!');
        window.location.href = '/learn/index.html';
    } catch (err) {
        console.error('[SIGNUP] Exception:', err);
        alert('An error occurred while signing up.');
        try {
          turnstile.reset();
          await new Promise(resolve => setTimeout(resolve, 500));
        } catch {}
    } finally {
        if (submitBtn) submitBtn.disabled = false;
    }
  });
  </script>
  

<script>
// --- Splash text ---
const variants = [
  { text: "welcomeAboard" },
  { text: "createSomethingCool" },
  { text: "devJourneyStarts" },
  { text: "smallStepsBigBuilds" },
  { text: "designCodeRepeat" },
  { text: "developedByBroodje56", link: "https://broodje56.is-a.dev" },
  { text: "developedByJoren", link: "https://github.com/JorenS15" },
  { text: "joinDiscord", link: "https://discord.gg/rKgF9s32EV" },
  { text: "programmingEqualsLife" },
  { text: "keepPushingForward" },
  { text: "codeYourDreams" },
  { text: "debuggingIsFun" },
  { text: "eatSleepCodeRepeat" },
  { text: "thinkTwiceCodeOnce" },
  { text: "helloWorld" },
  { text: "brainExeStopped" },
  { text: "codeLikeABoss" },
  { text: "syntaxNeverSleeps" },
  { text: "fromIdeasToApps" },
  { text: "firstBugIsFriend" },
  { text: "ctrlSProgress" },
  { text: "keepCalmCodeOn" },
  { text: "oneLineAtATime" },
  { text: "compileYourDreams" },
  { text: "futureDevInProgress" },
  { text: "readySetDeploy" },
  { text: "helloFutureProgrammer" },
  { text: "error404" },
  { text: "learningNeverStops" },
  { text: "codingPlusMusic", link: "https://open.spotify.com/track/4tZgM0PdoK8MG5jvMKdJkC" }
];

const choice = variants[Math.floor(Math.random() * variants.length)];
const box = document.querySelector('.login-card');
if (box) {
  const a = document.createElement('a');
  a.className = 'splash';
  if (choice.link) a.href = choice.link;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  const lang = localStorage.getItem('language') || 'en';
  a.textContent = translations[lang][choice.text] || choice.text;
  box.appendChild(a);
}
</script>

</body>
</html>